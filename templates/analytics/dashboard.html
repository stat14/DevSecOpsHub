{% extends "base.html" %}

{% block title %}Analytics Dashboard{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css" rel="stylesheet">
<style>
    .analytics-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    
    .analytics-card:hover {
        transform: translateY(-5px);
    }
    
    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .metric-card {
        text-align: center;
        padding: 1rem;
        border-radius: 10px;
        background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 1rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .filter-section {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1 class="display-4">Analytics Dashboard</h1>
        <p class="lead">Comprehensive insights and metrics for your security and development operations</p>
    </div>

    <!-- Filters -->
    <div class="filter-section">
        <div class="row">
            <div class="col-md-3">
                <label for="dateRange" class="form-label">Date Range</label>
                <select class="form-select" id="dateRange">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="projectFilter" class="form-label">Project</label>
                <select class="form-select" id="projectFilter">
                    <option value="">All Projects</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="metricType" class="form-label">Metric Type</label>
                <select class="form-select" id="metricType">
                    <option value="security">Security Metrics</option>
                    <option value="development">Development Metrics</option>
                    <option value="user">User Activity</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Key Metrics Row -->
    <div class="row" id="metricsRow">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value" id="totalProjects">0</div>
                <div class="metric-label">Total Projects</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card" style="background: linear-gradient(45deg, #fa709a 0%, #fee140 100%);">
                <div class="metric-value" id="totalFindings">0</div>
                <div class="metric-label">Security Findings</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card" style="background: linear-gradient(45deg, #a8edea 0%, #fed6e3 100%); color: #333;">
                <div class="metric-value" id="totalTasks">0</div>
                <div class="metric-label">Active Tasks</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card" style="background: linear-gradient(45deg, #d299c2 0%, #fef9d7 100%); color: #333;">
                <div class="metric-value" id="activeUsers">0</div>
                <div class="metric-label">Active Users</div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row">
        <div class="col-md-8">
            <div class="chart-container">
                <h5><i class="fas fa-shield-alt text-danger"></i> Security Findings Trend</h5>
                <canvas id="securityTrendChart" height="300"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container">
                <h5><i class="fas fa-chart-pie text-warning"></i> Risk Distribution</h5>
                <canvas id="riskDistributionChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <h5><i class="fas fa-tasks text-info"></i> Task Completion Rate</h5>
                <canvas id="taskCompletionChart" height="250"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h5><i class="fas fa-users text-success"></i> Team Productivity</h5>
                <canvas id="teamProductivityChart" height="250"></canvas>
            </div>
        </div>
    </div>

    <!-- Charts Row 3 -->
    <div class="row">
        <div class="col-md-4">
            <div class="chart-container">
                <h5><i class="fas fa-project-diagram text-primary"></i> Project Status</h5>
                <canvas id="projectStatusChart" height="200"></canvas>
            </div>
        </div>
        <div class="col-md-8">
            <div class="chart-container">
                <h5><i class="fas fa-chart-line text-secondary"></i> User Activity Timeline</h5>
                <canvas id="userActivityChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row">
        <div class="col-12">
            <div class="chart-container">
                <h5><i class="fas fa-history text-dark"></i> Recent Activity</h5>
                <div class="table-responsive">
                    <table class="table table-hover" id="recentActivityTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Time</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>Impact</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Analytics Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="mb-3">
                        <label for="exportFormat" class="form-label">Format</label>
                        <select class="form-select" id="exportFormat">
                            <option value="pdf">PDF Report</option>
                            <option value="csv">CSV Data</option>
                            <option value="json">JSON Data</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="exportDateRange" class="form-label">Date Range</label>
                        <select class="form-select" id="exportDateRange">
                            <option value="7">Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="365">Last year</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeCharts" checked>
                            <label class="form-check-label" for="includeCharts">
                                Include Charts and Visualizations
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="exportReport()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<button class="fab" data-bs-toggle="modal" data-bs-target="#exportModal" title="Export Report">
    <i class="fas fa-download"></i>
</button>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
<script>
// Initialize charts
let charts = {};

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadDashboardData();
    
    // Auto-refresh every 30 seconds
    setInterval(refreshDashboard, 30000);
});

function initializeCharts() {
    // Security Trend Chart
    const securityCtx = document.getElementById('securityTrendChart').getContext('2d');
    charts.securityTrend = new Chart(securityCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Critical',
                data: [],
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                tension: 0.4
            }, {
                label: 'High',
                data: [],
                borderColor: '#f39c12',
                backgroundColor: 'rgba(243, 156, 18, 0.1)',
                tension: 0.4
            }, {
                label: 'Medium',
                data: [],
                borderColor: '#f1c40f',
                backgroundColor: 'rgba(241, 196, 15, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Risk Distribution Chart
    const riskCtx = document.getElementById('riskDistributionChart').getContext('2d');
    charts.riskDistribution = new Chart(riskCtx, {
        type: 'doughnut',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low', 'Info'],
            datasets: [{
                data: [0, 0, 0, 0, 0],
                backgroundColor: ['#e74c3c', '#f39c12', '#f1c40f', '#27ae60', '#3498db']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Task Completion Chart
    const taskCtx = document.getElementById('taskCompletionChart').getContext('2d');
    charts.taskCompletion = new Chart(taskCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Completed',
                data: [],
                backgroundColor: '#27ae60'
            }, {
                label: 'In Progress',
                data: [],
                backgroundColor: '#f39c12'
            }, {
                label: 'Pending',
                data: [],
                backgroundColor: '#e74c3c'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    stacked: true
                },
                y: {
                    stacked: true,
                    beginAtZero: true
                }
            }
        }
    });

    // Team Productivity Chart
    const teamCtx = document.getElementById('teamProductivityChart').getContext('2d');
    charts.teamProductivity = new Chart(teamCtx, {
        type: 'radar',
        data: {
            labels: [],
            datasets: [{
                label: 'Tasks Completed',
                data: [],
                backgroundColor: 'rgba(52, 144, 220, 0.2)',
                borderColor: '#3490dc',
                pointBackgroundColor: '#3490dc'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true
                }
            }
        }
    });

    // Project Status Chart
    const projectCtx = document.getElementById('projectStatusChart').getContext('2d');
    charts.projectStatus = new Chart(projectCtx, {
        type: 'pie',
        data: {
            labels: ['Active', 'Completed', 'On Hold', 'Cancelled'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: ['#27ae60', '#3498db', '#f39c12', '#e74c3c']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // User Activity Chart
    const activityCtx = document.getElementById('userActivityChart').getContext('2d');
    charts.userActivity = new Chart(activityCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Daily Active Users',
                data: [],
                borderColor: '#9b59b6',
                backgroundColor: 'rgba(155, 89, 182, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function loadDashboardData() {
    Promise.all([
        fetch('/analytics/api/security-metrics'),
        fetch('/analytics/api/development-metrics'),
        fetch('/analytics/api/user-activity'),
        fetch('/analytics/api/project-overview')
    ]).then(responses => Promise.all(responses.map(r => r.json())))
    .then(([security, development, userActivity, projects]) => {
        updateMetrics(security, development, userActivity, projects);
        updateCharts(security, development, userActivity, projects);
    })
    .catch(error => {
        console.error('Error loading dashboard data:', error);
    });
}

function updateMetrics(security, development, userActivity, projects) {
    document.getElementById('totalProjects').textContent = projects.status_distribution.reduce((sum, item) => sum + item.count, 0);
    document.getElementById('totalFindings').textContent = security.top_vulnerabilities.reduce((sum, item) => sum + item.count, 0);
    document.getElementById('totalTasks').textContent = development.task_trends.filter(t => t.status === 'in_progress').reduce((sum, item) => sum + item.count, 0);
    document.getElementById('activeUsers').textContent = userActivity.daily_activity.slice(-1)[0]?.users || 0;
}

function updateCharts(security, development, userActivity, projects) {
    // Update security trend chart
    if (security.severity_trend) {
        const dates = Object.values(security.severity_trend)[0]?.dates || [];
        charts.securityTrend.data.labels = dates;
        charts.securityTrend.data.datasets[0].data = security.severity_trend.critical?.counts || [];
        charts.securityTrend.data.datasets[1].data = security.severity_trend.high?.counts || [];
        charts.securityTrend.data.datasets[2].data = security.severity_trend.medium?.counts || [];
        charts.securityTrend.update();
    }

    // Update risk distribution chart
    const severities = ['critical', 'high', 'medium', 'low', 'informational'];
    const riskData = severities.map(s => security.severity_trend[s]?.counts.reduce((a, b) => a + b, 0) || 0);
    charts.riskDistribution.data.datasets[0].data = riskData;
    charts.riskDistribution.update();

    // Update project status chart
    charts.projectStatus.data.datasets[0].data = projects.status_distribution.map(item => item.count);
    charts.projectStatus.update();

    // Update user activity chart
    charts.userActivity.data.labels = userActivity.daily_activity.map(item => item.date);
    charts.userActivity.data.datasets[0].data = userActivity.daily_activity.map(item => item.users);
    charts.userActivity.update();
}

function refreshDashboard() {
    loadDashboardData();
}

function exportReport() {
    const format = document.getElementById('exportFormat').value;
    const dateRange = document.getElementById('exportDateRange').value;
    const includeCharts = document.getElementById('includeCharts').checked;
    
    window.location.href = `/analytics/api/custom-report?type=summary&format=${format}&days=${dateRange}&charts=${includeCharts}`;
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('exportModal'));
    modal.hide();
}
</script>
{% endblock %}